package pk.edu.msspark.query;

import java.io.Serializable;
import java.util.ArrayList;

import org.apache.spark.api.java.JavaDoubleRDD;
import org.apache.spark.api.java.JavaPairRDD;
import org.apache.spark.api.java.JavaRDD;
import org.apache.spark.api.java.JavaSparkContext;
import org.apache.spark.api.java.function.DoubleFunction;
import org.apache.spark.broadcast.Broadcast;

import pk.edu.msspark.resultRDD.*;
import pk.edu.msspark.selectionRDD.FrameAtomsRDD;
import pk.edu.msspark.selectionRDD.SelectedAtomsRDD;
import pk.edu.msspark.utils.*;
import scala.Tuple2;

/* OneBodyQuery class implements one body queries
 * for Molecular Simulation data
 */

public class MSQuery{

	// file format 
	Broadcast<Integer> offset;
	Broadcast<Integer> pos;
	Broadcast<Integer> mass_index;
	Broadcast<Integer> charge_index;
	// spark context object
	JavaSparkContext sc;
	
	/* Constructor that broadcasts the required variables
	 */
	public MSQuery(JavaSparkContext sc){
		this.sc = sc;
		offset = sc.broadcast(FileFormat.FRAME_NO_INDEX + 1);
		pos = sc.broadcast(FileFormat.POS_VEC_INDEX);
		mass_index = sc.broadcast(FileFormat.MASS_INDEX);
		charge_index = sc.broadcast(FileFormat.CHARGE_INDEX);
	}
	
	/* Function to calculate MOI 
	 */
	public VectorRDD getMOI(FrameAtomsRDD f){		
		return new VectorRDD(f.getFrameAtomsRDD()
				.mapValues(new ConvertToMoiVec(offset, pos, mass_index))
				.reduceByKey(new AddVector()));
	}
	
	/* Function to calculate MOI 
	 */
	public VectorRDD getMOI(SelectedAtomsRDD f){
		return new VectorRDD(f.getSelectedAtomsRDD()
				.mapValues(new ConvertToMoiVec(offset, pos, mass_index))
				.reduceByKey(new AddVector()));
	}
	
	/* Function to calculate SOM 
	 */
	public ScalarRDD getSOM(FrameAtomsRDD f){		
		return new ScalarRDD(f.getFrameAtomsRDD()
				.mapValues(new ConvertToSomScalar(offset, mass_index))
				.reduceByKey(new AddScalar()));
	}
	
	/* Function to calculate SOM 
	 */
	public ScalarRDD getSOM(SelectedAtomsRDD f){
		return new ScalarRDD(f.getSelectedAtomsRDD()
				.mapValues(new ConvertToSomScalar(offset, mass_index))
				.reduceByKey(new AddScalar()));
	}
	
	/* Function to calculate COM 
	 */
	public VectorRDD getCOM(FrameAtomsRDD f){		
		return new VectorRDD(f.getFrameAtomsRDD()
				.mapValues(new ConvertToComArray(offset, pos, mass_index))
				.reduceByKey(new AddArray())
				.mapValues(new ConvertToCom()));
	}
	
	/* Function to calculate COM 
	 */
	public VectorRDD getCOM(SelectedAtomsRDD f){
		return new VectorRDD(f.getSelectedAtomsRDD()
				.mapValues(new ConvertToComArray(offset, pos, mass_index))
				.reduceByKey(new AddArray())
				.mapValues(new ConvertToCom()));
	}
	
	/* Function to calculate DM
	 */
	public VectorRDD getDM(FrameAtomsRDD f){		
		return new VectorRDD(f.getFrameAtomsRDD()
				.mapValues(new ConvertToDMVec(offset, pos, charge_index))
				.reduceByKey(new AddVector()));
	}
	
	/* Function to calculate DM 
	 */
	public VectorRDD getDM(SelectedAtomsRDD f){
		return new VectorRDD(f.getSelectedAtomsRDD()
				.mapValues(new ConvertToDMVec(offset, pos, charge_index))
				.reduceByKey(new AddVector()));
	}
	
	/* Function to calculate ROG
	 */
	public ScalarRDD getROG(FrameAtomsRDD f, String ax){
		int a;
		if(ax.equals("x")) a = 0;
		else if(ax.equals("y")) a = 1;
		else a = 2;	
		Broadcast<Integer> axis = sc.broadcast(a);
		return new ScalarRDD(f.getFrameAtomsRDD()
				.mapValues(new ConvertToRogArray(offset, pos, mass_index, axis))
				.reduceByKey(new AddArray())
				.mapValues(new ConvertToRog()));
	}
	
	/* Function to calculate ROG 
	 */
	public ScalarRDD getROG(SelectedAtomsRDD f, String ax){
		int a;
		if(ax.equals("x")) a = 0;
		else if(ax.equals("y")) a = 1;
		else a = 2;
		Broadcast<Integer> axis = sc.broadcast(a);
		return new ScalarRDD(f.getSelectedAtomsRDD()
				.mapValues(new ConvertToRogArray(offset, pos, mass_index, axis))
				.reduceByKey(new AddArray())
				.mapValues(new ConvertToRog()));
	}
	
	/* Function to calculate SDH
	 */
	public JavaPairRDD<Integer,Tuple2<double[], long[]>> getSDH( FrameAtomsRDD f, int bw){		
		Broadcast<Integer> bin = sc.broadcast(bw);
		JavaPairRDD<Integer,Tuple2<double[], long[]>> result = f.getFrameAtomsRDD()
				.mapValues(new ConvertToSDHVec(offset, pos))
				.mapPartitionsToPair(new ConvertToHist(sc,bin));
		return result;
	}
	
	/* Function to calculate DM 
	 */
	public void getSDH(SelectedAtomsRDD f, int[] frames){
		JavaPairRDD<Integer, Vector3D> result = f.getSelectedAtomsRDD()
				.mapValues(new ConvertToSDHVec(offset, pos));
				//.mapPartitionsToPair(new ConvertToDist(),true);
		//result.repartition(frames.length);
		Broadcast<Integer> frame;
		JavaRDD<Vector3D> pos;
		JavaDoubleRDD dist;
		Tuple2<double[], long[]> hist;
		for(int i=0;i<frames.length;i++){
			frame = sc.broadcast(frames[i]);
			pos =result.
					filter(new GetFrame(frame)).values();
			dist =	pos.cartesian(pos).map(new CalculateDist()).mapToDouble(new GetDouble());
			hist = dist.histogram(3);
			for(int j=0;j<hist._1.length;j++){
				System.out.print(hist._1[j]+" : ");
				for(int k=0;k<hist._2.length;k++){
					System.out.print(hist._1[k]+" : ");
				}
			}
		}
	}
	
	
}



